{% extends 'layout.html' %}
{% block content %}
<h2 class="section-title">Réservations des courts</h2>

<form method="get" class="mb-4">
    <div class="input-group reservations-select-date">
        <span class="input-group-text">Date</span>
        <input type="date" class="form-control" name="date" value="{{ selected_date }}" onchange="this.form.submit()">
    </div>
</form>

<div class="row">
    <div class="col-lg-8 mb-4">
        <h3 class="mb-3">Planning du {{ selected_date }}</h3>
        <div class="table-responsive">
            <table class="table table-bordered text-center align-middle">
                <thead>
                <tr>
                    <th>Heure</th>
                    <th>Court 1</th>
                    <th>Court 2</th>
                    <th>Court 3</th>
                </tr>
                </thead>
                <tbody>
                {% for slot in time_slots %}
                    <tr>
                        <th scope="row" class="time-slot">{{ slot[0] }} – {{ slot[1] }}</th>
                        {% for court in (1, 2, 3) %}
                            {% set is_reserved = availability[court][slot] %}
                            <td>
                                {% if is_reserved %}
                                    <div class="bg-danger text-white py-2 rounded">Réservé</div>
                                {% else %}
                                    <button type="button" class="btn btn-outline-success w-100 slot-available" data-court="{{ court }}" data-start="{{ slot[0] }}" data-end="{{ slot[1] }}">
                                        Libre
                                    </button>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="text-muted"><small>Cliquez sur un créneau libre pour créer une réservation d'une heure.</small></p>
        <!-- Formulaire caché pour envoyer la réservation -->
        <form id="reservationForm" method="post" style="display: none;">
            <input type="hidden" name="date" value="{{ selected_date }}">
            <input type="hidden" name="court_number" id="form_court_number">
            <input type="hidden" name="start_time" id="form_start_time">
            <input type="hidden" name="end_time" id="form_end_time">
        </form>
    </div>
    <div class="col-lg-4">
        <h3>Mes réservations</h3>
        {% if user_reservations %}
        <table class="table table-bordered table-sm">
            <thead>
            <tr>
                <th>Date</th>
                <th>Court</th>
                <th>Début</th>
                <th>Fin</th>
            </tr>
            </thead>
            <tbody>
            {% for r in user_reservations %}
                <tr>
                    <td>{{ r.date }}</td>
                    <td>{{ r.court_number }}</td>
                    <td>{{ r.start_time }}</td>
                    <td>{{ r.end_time }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>Vous n'avez pas encore de réservation.</p>
        {% endif %}
    </div>
</div>

<!-- Script pour traiter le clic sur un créneau libre -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const slots = document.querySelectorAll('.slot-available');
        slots.forEach(function (btn) {
            btn.addEventListener('click', function () {
                const court = this.getAttribute('data-court');
                const start = this.getAttribute('data-start');
                const end = this.getAttribute('data-end');
                document.getElementById('form_court_number').value = court;
                document.getElementById('form_start_time').value = start;
                document.getElementById('form_end_time').value = end;
                document.getElementById('reservationForm').submit();
            });
        });
    });
</script>
{% endblock %}