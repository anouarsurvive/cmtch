{% extends 'layout.html' %}
{% block content %}
<!-- Section des réservations moderne -->
<section class="reservations-section py-5">
    <div class="container">
        <!-- En-tête de la page -->
        <div class="page-header text-center mb-5">
            <h2 class="section-title">Réservations des courts</h2>
            <p class="lead text-muted">Réservez votre créneau de tennis en quelques clics</p>
        </div>

        <!-- Sélecteur de date -->
        <div class="date-selector-wrapper mb-5">
            <form method="get" class="date-selector-form">
                <div class="row justify-content-center">
                    <div class="col-md-6 col-lg-4">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-primary text-white">
                                <i class="fas fa-calendar-alt"></i>
                            </span>
                            <input type="date" 
                                   class="form-control" 
                                   name="date" 
                                   value="{{ selected_date }}" 
                                   onchange="this.form.submit()"
                                   min="{{ today_date }}">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="row">
            <!-- Planning principal -->
            <div class="col-lg-8 mb-4">
                <div class="schedule-card">
                    <div class="schedule-header">
                        <h3 class="schedule-title">
                            <i class="fas fa-calendar-day me-2"></i>
                            Planning du {{ selected_date }}
                        </h3>
                        <div class="schedule-legend">
                            <span class="legend-item">
                                <span class="legend-color available"></span>
                                Libre
                            </span>
                            <span class="legend-item">
                                <span class="legend-color reserved"></span>
                                Réservé
                            </span>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table schedule-table">
                            <thead>
                                <tr>
                                    <th class="time-header">Heure</th>
                                    <th class="court-header">Court 1</th>
                                    <th class="court-header">Court 2</th>
                                    <th class="court-header">Court 3</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for slot in time_slots %}
                                <tr class="time-row">
                                    <th scope="row" class="time-slot">
                                        <div class="time-display">
                                            <span class="time-start">{{ slot[0] }}</span>
                                            <span class="time-separator">–</span>
                                            <span class="time-end">{{ slot[1] }}</span>
                                        </div>
                                    </th>
                                    {% for court in (1, 2, 3) %}
                                        {% set slot_info = availability[court][slot] %}
                                        {% set is_reserved = slot_info.reserved %}
                                        <td class="court-cell">
                                            {% if is_reserved %}
                                                {% set reservation_info = slot_info.reservation_info %}
                                                <div class="slot-reserved {% if reservation_info.is_current_user %}slot-own-reservation{% endif %}">
                                                    <i class="fas fa-lock me-2"></i>
                                                    <div class="reservation-details">
                                                        <span class="reserved-by">
                                                            {% if reservation_info.is_current_user %}
                                                                <strong>Vous</strong>
                                                            {% else %}
                                                                {{ reservation_info.user_full_name }}
                                                            {% endif %}
                                                        </span>
                                                        <small class="username-display">@{{ reservation_info.username }}</small>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <button type="button" 
                                                        class="btn slot-available" 
                                                        data-court="{{ court }}" 
                                                        data-start="{{ slot[0] }}" 
                                                        data-end="{{ slot[1] }}"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#reservationModal">
                                                    <i class="fas fa-check me-2"></i>
                                                    <span>Libre</span>
                                                </button>
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="schedule-footer">
                        <p class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Cliquez sur un créneau libre pour créer une réservation d'une heure.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Mes réservations -->
            <div class="col-lg-4">
                <div class="my-reservations-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list me-2"></i>
                            Mes réservations
                        </h3>
                    </div>
                    
                    <div class="card-body">
                        {% if user_reservations %}
                            <div class="reservations-list">
                                {% for r in user_reservations %}
                                    <div class="reservation-item">
                                        <div class="reservation-header">
                                            <span class="reservation-date">
                                                <i class="fas fa-calendar me-1"></i>
                                                {{ r.date }}
                                            </span>
                                            <span class="reservation-court">
                                                <i class="fas fa-tennis-ball me-1"></i>
                                                Court {{ r.court_number }}
                                            </span>
                                        </div>
                                        <div class="reservation-time">
                                            <i class="fas fa-clock me-1"></i>
                                            {{ r.start_time }} - {{ r.end_time }}
                                        </div>
                                        <div class="reservation-actions">
                                            <a href="/reservations/{{ r.id }}/export-ics" 
                                               class="btn btn-sm btn-outline-primary me-1"
                                               title="Exporter vers le calendrier">
                                                <i class="fas fa-calendar-plus"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="cancelReservation({{ r.id }})"
                                                    title="Annuler la réservation">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-reservations">
                                <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Aucune réservation</h5>
                                <p class="text-muted">Vous n'avez pas encore de réservation.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal de confirmation de réservation -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reservationModalLabel">
                    <i class="fas fa-calendar-check me-2"></i>
                    Confirmer la réservation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="reservation-details">
                    <div class="detail-item">
                        <i class="fas fa-calendar me-2"></i>
                        <strong>Date :</strong> <span id="modal-date">{{ selected_date }}</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-tennis-ball me-2"></i>
                        <strong>Court :</strong> <span id="modal-court"></span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-clock me-2"></i>
                        <strong>Horaire :</strong> <span id="modal-time"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Annuler
                </button>
                <form id="reservationForm" method="post" style="display: inline;">
                    <input type="hidden" name="date" value="{{ selected_date }}">
                    <input type="hidden" name="court_number" id="form_court_number">
                    <input type="hidden" name="start_time" id="form_start_time">
                    <input type="hidden" name="end_time" id="form_end_time">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check me-2"></i>Confirmer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Gestion des clics sur les créneaux libres
    const slots = document.querySelectorAll('.slot-available');
    slots.forEach(function (btn) {
        btn.addEventListener('click', function () {
            const court = this.getAttribute('data-court');
            const start = this.getAttribute('data-start');
            const end = this.getAttribute('data-end');
            
            // Mise à jour du modal
            document.getElementById('modal-court').textContent = 'Court ' + court;
            document.getElementById('modal-time').textContent = start + ' - ' + end;
            
            // Mise à jour du formulaire caché
            document.getElementById('form_court_number').value = court;
            document.getElementById('form_start_time').value = start;
            document.getElementById('form_end_time').value = end;
        });
    });
});

function cancelReservation(reservationId) {
    if (confirm('Êtes-vous sûr de vouloir annuler cette réservation ?')) {
        // Ici vous pouvez ajouter la logique pour annuler la réservation
        // Par exemple, faire une requête AJAX vers une route de suppression
        console.log('Annulation de la réservation:', reservationId);
    }
}

// Animation des créneaux au survol
document.querySelectorAll('.slot-available').forEach(slot => {
    slot.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.05)';
    });
    
    slot.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
    });
});
</script>
{% endblock %}